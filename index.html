<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîå Ladestoppfinder üçî</title>
    <subtitle>Stand: 26.12.2025</subtitle>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <style>
        /* --- CSS VARIABLES & THEMES --- */
        :root {
            /* Default: Dark Mode */
            --bg-color: #121212;
            --header-bg: #1e1e1e;
            --text-color: #ffffff;
            --card-bg: #2c2c2c;

            /* Picker Colors */
            --picker-bg: #333;
            --picker-highlight: rgba(255, 255, 255, 0.1);
            --charger-color: #64b5f6; /* Hellblau */
            --food-color: #ffb74d;    /* Orange */
        }

        /* Light Mode Klasse */
        body.light-mode {
            --bg-color: #f5f5f5;
            --header-bg: #ffffff;
            --text-color: #333333;
            --card-bg: #ffffff;
            --picker-bg: #e0e0e0;
            --picker-highlight: rgba(0, 0, 0, 0.05);
            --charger-color: #1976d2;
            --food-color: #d84315;
        }/* --- BASIC SETUP --- */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        header {
            background-color: var(--header-bg);
            padding: 0.5rem 1rem 0 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        h1 {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            background: var(--card-bg);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid #555;
            user-select: none;
        }/* --- PICKER STYLES --- */
        .picker-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
            height: 160px;
        }

        .picker-separator {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-color);
            margin-top: -10px;
            opacity: 0.5;
        }

        .wheel-picker {
            width: 160px;
            height: 150px;
            background-color: var(--picker-bg);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            /* Fade Effect */
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 35%, black 65%, transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 35%, black 65%, transparent 100%);
        }

        .charger-picker { border-color: var(--charger-color); color: var(--charger-color); }
        .restaurant-picker { border-color: var(--food-color); color: var(--food-color); }

        .picker-strip {
            position: absolute;
            top: 0; left: 0; width: 100%;
            transform: translateY(0);
            /* 3 Sekunden Dauer, schnelles Starten, langsames Ende (Ease Out) */
            transition: transform 3s cubic-bezier(0.1, 1.0, 0.2, 1.0); 

        }.picker-item {
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.1rem;
            white-space: nowrap;
            cursor: pointer;
        }

        .picker-highlight-bar {
            position: absolute;
            top: 50%; left: 0; width: 100%; height: 50px;
            margin-top: -25px;
            background-color: var(--picker-highlight);
            pointer-events: none;
            border-top: 1px solid rgba(255,255,255,0.15);
            border-bottom: 1px solid rgba(255,255,255,0.15);
            z-index: -1;
        }

        /* --- MAP & ICONS --- */
        #map {
            flex-grow: 1;
            width: 100%;
            z-index: 1;
        }.custom-div-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            font-size: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.6);
            border-radius: 50%;
            border: 2px solid white;
        }
        
        /* Marker Farben - passend zur Python config */
        .bg-tesla { background: #e82127; }
        .bg-ionity { background: #1e3d59; }
        .bg-enbw { background: #76c043; }
        .bg-mcd { background: #ffc72c; color: #000; } 
        .bg-bk { background: #512814; }
        
        /* Popup Styling */
        .leaflet-popup-content-wrapper {
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 8px;
        }
        .leaflet-popup-tip {
            background: var(--card-bg);
        }

    </style>
</head>
<body>

    <header>
        <h1>üîå Ladestoppfinder üçî</h1>
        <h2>Stand: 26.12.2025</h2>        
        <div class="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è / üåô</div>
        
        <div class="picker-container">
            <!-- CHARGER PICKER -->
            <div class="wheel-picker charger-picker" id="picker-charger-container">
                <div class="picker-highlight-bar"></div>
                <!-- Inhalt ist leer, wird per JS gef√ºllt -->
                <div class="picker-strip" id="chargerStrip"></div>
            </div>

            <div class="picker-separator">+</div>

            <!-- RESTAURANT PICKER -->
            <div class="wheel-picker restaurant-picker" id="picker-food-container">
                <div class="picker-highlight-bar"></div>
                <!-- Inhalt ist leer, wird per JS gef√ºllt -->
                <div class="picker-strip" id="restaurantStrip"></div>
            </div>
        </div>
    </header>


    <main id="map"></main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
    /* --------------------------------------------------
       1. VARIABLEN
    -------------------------------------------------- */
    let allData = []; 
    // Wir speichern jetzt IDs (z.B. 'tesla', 'mcdonald') statt dem angezeigten Text
    let currentFilters = {
        chargerId: 'all', 
        foodId: 'all'
    };

    const markerGroup = L.layerGroup(); 

    /* --------------------------------------------------
       2. THEME
    -------------------------------------------------- */
    function initTheme() {
        if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
    }
    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    }

    /* --------------------------------------------------
       3. MAP INIT
    -------------------------------------------------- */
    // Start bei einem Mittelpunkt zwischen Sachsen und Nordbayern, mit passendem Zoom
    const map = L.map('map').setView([50.35, 12.5], 8); 

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    markerGroup.addTo(map); 

    /* --------------------------------------------------
       4. DATEN FILTERN & MARKER
    -------------------------------------------------- */
    function renderMarkers() {
        markerGroup.clearLayers(); 

        let count = 0;
        
        allData.forEach(entry => {
            // FILTER LOGIK: "UND" Verkn√ºpfung
            const chargerMatch = (currentFilters.chargerId === 'all') || (entry.charger_id === currentFilters.chargerId);
            const foodMatch    = (currentFilters.foodId === 'all')    || (entry.food_id === currentFilters.foodId);if (chargerMatch && foodMatch) {
                count++;
                
                // Icon: Wir nehmen die Farbe des Laders (badge_class), da das meist wichtiger ist
                const myIcon = L.divIcon({
                    className: `custom-div-icon ${entry.badge_class}`,
                    html: `‚ö°`, // Kleines Blitz-Symbol im Marker
                    iconSize: [30, 30], 
                    iconAnchor: [15, 15], 
                });

                L.marker([entry.lat, entry.lon], {icon: myIcon})
                    .addTo(markerGroup)
                    .bindPopup(entry.description); // Beschreibung kommt direkt fertig aus JSON
            }
        });
        
        console.log(`Zeige ${count} Treffer an.`);
    }

    async function loadData() {
        try {
            // Nimm timestamp, um Caching zu verhindern beim Testen
            const response = await fetch('data.json?t=' + new Date().getTime());
            if (!response.ok) throw new Error("Keine data.json gefunden");
            allData = await response.json();
            renderMarkers(); 
        } catch (error) {
            console.error(error);
            alert("Daten konnten nicht geladen werden.");
        }
    }

    /* --------------------------------------------------
       5. PICKER LOGIK (Slot Machine Style)
    -------------------------------------------------- */
    const itemHeight = 50; 
    const pickerHeight = 150;

    // Wir definieren die Optionen hier
    const chargerOptions = [
        { id: 'tesla', text: 'Tesla' },
        { id: 'ionity', text: 'IONITY' },
        { id: 'enbw', text: 'EnBW' },
        { id: 'all', text: 'Alle Ladeanbieter' } // Ziel am Ende des Arrays
    ];

    const foodOptions = [
        { id: 'mcdonald', text: "McDonald's" },
        { id: 'burger king', text: 'Burger King' },
        { id: 'lounge', text: 'Lounge' },
        { id: 'all', text: 'Alle Restaurants' }   // Ziel am Ende des Arrays
    ];

    /**
     * F√ºllt den Picker-Streifen mit HTML.
     * Wiederholt die Liste 'repeatCount' mal, damit der Spin lang wirkt.
     */
    function initPickerStrip(stripId, options, repeatCount = 10) {
        const strip = document.getElementById(stripId);
        let htmlContent = '';
        
        for (let i = 0; i < repeatCount; i++) {
            options.forEach(opt => {
                htmlContent += `<div class="picker-item" data-id="${opt.id}">${opt.text}</div>`;
            });
        }
        strip.innerHTML = htmlContent;
    }

    function scrollToElement(stripId, targetElement, duration = null) {
        if(!targetElement) return;

        const strip = document.getElementById(stripId);
        
        // Optional: Tempor√§r Transition-Zeit √ºberschreiben (z.B. f√ºr schnelles Scrollen beim Klicken)
        if (duration !== null) {
            strip.style.transition = `transform ${duration}`;
        } else {
            // Zur√ºck zum CSS Standard (3s f√ºr den gro√üen Spin, oder was in CSS steht)
            // Wir setzen es hier zur√ºck auf den CSS Wert, falls es verstellt wurde
            strip.style.transition = ''; 
        }

        const items = Array.from(strip.querySelectorAll('.picker-item'));
        const index = items.indexOf(targetElement);

        if (index !== -1) {
            const centerOffset = (pickerHeight / 2) - (itemHeight / 2); 
            const totalScroll = (index * itemHeight) - centerOffset;
            strip.style.transform = `translateY(-${totalScroll}px)`;

            // ID auslesen und Filter setzen
            const selectedId = targetElement.getAttribute('data-id');

            if (stripId === 'chargerStrip') currentFilters.chargerId = selectedId;
            if (stripId === 'restaurantStrip') currentFilters.foodId = selectedId;

            // Karte erst updaten, wenn Animation ca. durch ist (debounce), 
            // oder sofort, wenn User klickt. Hier machen wir es einfach sofort.
            // (F√ºr den 3s Spin am Anfang updatet die Karte erst am Ende effektiv, 
            // da User eh noch zuschaut).
            renderMarkers();
        }
    }

    /**
     * Startet den gro√üen Anfangs-Spin.
     * Ziel: Das letzte Vorkommen von 'targetId' in der Liste finden.
     */
    function spinToWin(stripId, targetId) {
        const strip = document.getElementById(stripId);
        const items = Array.from(strip.querySelectorAll('.picker-item'));
        
        // Wir suchen von hinten, um das item weit unten zu finden -> langer Spin
        const foundIndex = items.map(i => i.getAttribute('data-id')).lastIndexOf(targetId);
        
        if (foundIndex !== -1) {
            // Wichtig: Wir wollen sicherstellen, dass wir bei 0 starten (optisch)
            // Da wir gerade erst geladen haben, ist transform noch 0.
            // Jetzt setzen wir den Target. Durch CSS transition: 3s dreht es sich.
            scrollToElement(stripId, items[foundIndex]);
        }
    }

    // Click & Wheel Events (angepasst f√ºr duplicated lists)
    function initInteract(stripId, containerId) {
        const strip = document.getElementById(stripId);
        const container = document.getElementById(containerId);

        // Klick Event
        strip.addEventListener('click', (e) => {
            if(e.target.classList.contains('picker-item')) {
                // Beim Klicken soll es zackig gehen (0.3s), nicht 3s warten
                strip.style.transition = 'transform 0.3s ease-out';
                scrollToElement(stripId, e.target, '0.3s ease-out');
            }
        });

        // Wheel Handler
        let isScrolling = false;
        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            if (isScrolling) return;
            isScrolling = true;
            setTimeout(() => { isScrolling = false; }, 50); // Schnellerer Reset

            const direction = e.deltaY > 0 ? 1 : -1;
            const items = strip.querySelectorAll('.picker-item');
            
            // Aktuelle Position berechnen
            const currentMatrix = getComputedStyle(strip).transform;
            // Matrix parsen um aktuellen Y-Wert zu bekommen (etwas tricky, einfacher Hack:)
            // Wir nehmen den Wert, den wir zuletzt gesetzt haben aus strip.style.transform
            let currentY = 0;
            if (strip.style.transform) {
                currentY = Math.abs(parseInt(strip.style.transform.replace('translateY(', '').replace('px)', '')));
            }

            let currentIndex = Math.round((currentY - (pickerHeight/2 - itemHeight/2)) / itemHeight);
            let newIndex = currentIndex + direction;

            // Bounds check
            if (newIndex < 0) newIndex = 0;
            if (newIndex >= items.length) newIndex = items.length - 1;

            // Beim Scrollen auch schnelle Transition
            strip.style.transition = 'transform 0.1s linear';
            scrollToElement(stripId, items[newIndex], '0.1s linear');

        }, { passive: false });
    }

    /* --------------------------------------------------
       6. START
    -------------------------------------------------- */
    window.addEventListener('DOMContentLoaded', () => {
        initTheme();
        
        // 1. Listen generieren (10x wiederholen f√ºr langen Spin)
        initPickerStrip('chargerStrip', chargerOptions, 10);
        initPickerStrip('restaurantStrip', foodOptions, 10);

        // 2. Interaktionen aktivieren
        initInteract('chargerStrip', 'picker-charger-container');
        initInteract('restaurantStrip', 'picker-food-container');

        // 3. Daten laden
        loadData();         

        // 4. Der "Gl√ºcksrad" Spin
        // Kurze Verz√∂gerung, damit der Browser das Rendern fertig hat, dann los
        setTimeout(() => {
            // CSS Transition f√ºr den Spin sicherstellen
            document.getElementById('chargerStrip').style.transition = 'transform 3s cubic-bezier(0.1, 1.0, 0.2, 1.0)';
            document.getElementById('restaurantStrip').style.transition = 'transform 3s cubic-bezier(0.1, 1.0, 0.2, 1.0)';
            
            spinToWin('chargerStrip', 'all');
            spinToWin('restaurantStrip', 'all');
        }, 100);
    });

    /* --------------------------------------------------
       6. START
    -------------------------------------------------- */
    window.addEventListener('DOMContentLoaded', () => {
        initTheme();
        
        // Interaktionen aktivieren
        initInteract('chargerStrip', 'picker-charger-container');
        initInteract('restaurantStrip', 'picker-food-container');

        loadData();         

        // Animation zum Start: Erst kurz warten, dann auf "Alle" scrollen
        setTimeout(() => {
            scrollByText('chargerStrip', 'Alle Ladeanbieter');
            scrollByText('restaurantStrip', 'Alle Restaurants');
        }, 500);
    });
    </script>
</body>
</html>
