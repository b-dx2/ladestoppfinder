name: Monatliches Karten-Update

on:
  schedule:
    - cron: '0 2 1 * *' # 02:00 UTC = 03:00/04:00 DE Zeit
  workflow_dispatch:      # Zum manuellen Starten

permissions:
  contents: write

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Repository auschecken
        uses: actions/checkout@v4

      - name: Python einrichten
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Abh√§ngigkeiten installieren
        run: pip install requests


      # --- SCRAPER ---
      - name: Scraper laufen lassen
        id: scraper   # <--- WICHTIG: Damit wir sp√§ter auf die Output-Variable zugreifen k√∂nnen
        run: |
          python scraper_germany.py

      # --- GIT COMMIT ---
      - name: Neue Daten speichern
        run: |
          git config --global user.name 'Update-Bot'
          git config --global user.email 'bot@noreply.github.com'
          
          if [[ -n $(git status -s) ]]; then
            # HIER √ÑNDERN: Wir f√ºgen data.json UND meta.js hinzu
            git add data.json meta.js
            
            git commit -m "Auto-Update: ${{ steps.scraper.outputs.stats_msg }}"
            git push
          else
            echo "Keine √Ñnderungen."
          fi

      # --- TELEGRAM NACHRICHT ---
      - name: Telegram Info senden
        if: always() # Sendet auch, wenn mal was schief geht
        run: |
          # 1. Erfolgs-Nachricht zusammenbauen
          if [ "${{ job.status }}" == "success" ]; then
             # Hier greifen wir auf die Berechnung aus Python zu!
             TEXT="üîã *Lade-Update fertig!*%0A%0AAktueller Stand: ${{ steps.scraper.outputs.stats_msg }}%0A%0Aüîó [Zur Karte](https://b-dx2.github.io/ladestoppfinder/)"
          else
             TEXT="‚ö†Ô∏è *Lade-Update fehlgeschlagen!*%0ABitte auf GitHub pr√ºfen."
          fi
          
          # 2. An Telegram senden
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_TO }} \
          -d parse_mode="Markdown" \
          -d text="$TEXT"
